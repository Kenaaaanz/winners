{% extends 'base_dashboard.html' %}
{% load custom_filters %}

{% block title %}Inventory Analysis - Winners Cosmetics{% endblock %}

{% block page_title %}
<i class="fas fa-boxes"></i> Inventory Analysis Report
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2 flex-wrap align-items-center">
    <a href="{% url 'sales_report' %}" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-chart-line"></i> Sales Report
    </a>
    <a href="{% url 'financial_report' %}" class="btn btn-sm btn-outline-success">
        <i class="fas fa-chart-pie"></i> Financial Report
    </a>
    <a href="{% url 'product_performance' %}" class="btn btn-sm btn-outline-warning">
        <i class="fas fa-star"></i> Product Performance
    </a>
    <div class="vr"></div>
    <a href="{% url 'export_report_pdf' %}?report_type=inventory" class="btn btn-sm btn-outline-danger">
        <i class="fas fa-file-pdf"></i> Export PDF
    </a>
    <a href="{% url 'export_inventory_csv' %}" class="btn btn-sm btn-outline-success">
        <i class="fas fa-file-export"></i> Export CSV
    </a>
    <a href="{% url 'low_stock' %}" class="btn btn-sm btn-outline-warning">
        <i class="fas fa-exclamation-triangle"></i> Low Stock
    </a>
</div>
{% endblock %}

{% block dashboard_content %}
<!-- Inventory Metrics -->
<div class="row mb-4 g-3">
    <div class="col-md-3">
        <div class="card h-100 border-0 shadow-sm" style="border-top: 4px solid #3b82f6;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <p class="text-muted small mb-2">Total Inventory Value</p>
                        <h3 class="font-weight-bold mb-1">KES {{ total_valuation|floatformat:2 }}</h3>
                        <small class="text-muted">{{ total_units }} units</small>
                    </div>
                    <i class="fas fa-coins text-info" style="font-size: 2rem; opacity: 0.2;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100 border-0 shadow-sm" style="border-top: 4px solid #10b981;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <p class="text-muted small mb-2">Total Products</p>
                        <h3 class="font-weight-bold mb-1">{{ total_products }}</h3>
                        <small class="text-muted">SKUs in catalog</small>
                    </div>
                    <i class="fas fa-box text-success" style="font-size: 2rem; opacity: 0.2;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100 border-0 shadow-sm" style="border-top: 4px solid #f59e0b;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <p class="text-muted small mb-2">Expiring Soon</p>
                        <h3 class="font-weight-bold mb-1">{{ expiring_soon_count }}</h3>
                        <small class="text-muted">Needs attention</small>
                    </div>
                    <i class="fas fa-calendar-times text-warning" style="font-size: 2rem; opacity: 0.2;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100 border-0 shadow-sm" style="border-top: 4px solid #ef4444;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <p class="text-muted small mb-2">Slow Moving</p>
                        <h3 class="font-weight-bold mb-1">{{ slow_moving_count }}</h3>
                        <small class="text-muted">Items at risk</small>
                    </div>
                    <i class="fas fa-sync-alt text-danger" style="font-size: 2rem; opacity: 0.2;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stock Health Dashboard -->
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-header bg-white border-bottom">
        <h5 class="card-title mb-0">
            <i class="fas fa-heartbeat text-primary"></i> Stock Health Dashboard
        </h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <div class="h4 text-success">{{ healthy_stock_count }}</div>
                        <small class="text-muted">Healthy Stock</small>
                        <p class="small mb-0 mt-1">Above reorder level</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <div class="h4 text-warning">{{ low_stock_count }}</div>
                        <small class="text-muted">Low Stock</small>
                        <p class="small mb-0 mt-1">Below reorder level</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <div class="h4 text-danger">{{ out_of_stock_count }}</div>
                        <small class="text-muted">Out of Stock</small>
                        <p class="small mb-0 mt-1">Zero inventory</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <div class="h4 text-info">{{ overstock_count }}</div>
                        <small class="text-muted">Overstock</small>
                        <p class="small mb-0 mt-1">Excess inventory</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                    <div class="metric-value text-info">{{ fast_moving_products|length }}</div>
                    <div class="metric-label">Fast Moving</div>
                    <small class="text-muted">High turnover rate</small>
                </div>
            </div>
        </div>
        
        <!-- Stock Health Progress -->
        <div class="mt-3">
            <div class="d-flex justify-content-between mb-1">
                <small>Stock Health Distribution</small>
                <small>{{ total_products }} products</small>
            </div>
            <div class="progress" style="height: 20px;">
                <div class="progress-bar bg-success" 
                     style="width: {% widthratio healthy_stock_count total_products 100 %}%">
                    Healthy ({{ healthy_stock_count }})
                </div>
                <div class="progress-bar bg-warning" 
                     style="width: {% widthratio low_stock_count total_products 100 %}%">
                    Low ({{ low_stock_count }})
                </div>
                <div class="progress-bar bg-danger" 
                     style="width: {% widthratio out_of_stock_count total_products 100 %}%">
                    Out ({{ out_of_stock_count }})
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i> Category Value Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="categoryValueChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie"></i> ABC Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="abcAnalysisChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ABC Analysis Details -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-sort-amount-down"></i> ABC Analysis Details
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Classification</th>
                        <th>Products</th>
                        <th>% of Products</th>
                        <th>Total Value</th>
                        <th>% of Value</th>
                        <th>Avg. Value</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% comment %}
                    <!-- This would be populated from ABC analysis data -->
                    {% endcomment %}
                    <tr>
                        <td><span class="abc-badge badge-a">A Class</span></td>
                        <td>{{ abc_summary.A.count|default:"N/A" }}</td>
                        <td>{{ abc_summary.A.percentage_of_products|default:"N/A" }}%</td>
                        <td class="text-success">KES {{ abc_summary.A.total_value|default:"N/A"|floatformat:2 }}</td>
                        <td>{{ abc_summary.A.percentage_of_value|default:"N/A" }}%</td>
                        <td>
                            {% if abc_summary.A.count > 0 %}
                            KES {{ abc_summary.A.total_value|divide:abc_summary.A.count|floatformat:2 }}
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td><small class="text-muted">High-value items (80% of value)</small></td>
                    </tr>
                    <tr>
                        <td><span class="abc-badge badge-b">B Class</span></td>
                        <td>{{ abc_summary.B.count|default:"N/A" }}</td>
                        <td>{{ abc_summary.B.percentage_of_products|default:"N/A" }}%</td>
                        <td class="text-warning">KES {{ abc_summary.B.total_value|default:"N/A"|floatformat:2 }}</td>
                        <td>{{ abc_summary.B.percentage_of_value|default:"N/A" }}%</td>
                        <td>
                            {% if abc_summary.B.count > 0 %}
                            KES {{ abc_summary.B.total_value|divide:abc_summary.B.count|floatformat:2 }}
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td><small class="text-muted">Medium-value items (15% of value)</small></td>
                    </tr>
                    <tr>
                        <td><span class="abc-badge badge-c">C Class</span></td>
                        <td>{{ abc_summary.C.count|default:"N/A" }}</td>
                        <td>{{ abc_summary.C.percentage_of_products|default:"N/A" }}%</td>
                        <td class="text-secondary">KES {{ abc_summary.C.total_value|default:"N/A"|floatformat:2 }}</td>
                        <td>{{ abc_summary.C.percentage_of_value|default:"N/A" }}%</td>
                        <td>
                            {% if abc_summary.C.count > 0 %}
                            KES {{ abc_summary.C.total_value|divide:abc_summary.C.count|floatformat:2 }}
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td><small class="text-muted">Low-value items (5% of value)</small></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Expiry Analysis -->
<div class="card mb-4 border-warning">
    <div class="card-header bg-warning text-dark">
        <h5 class="card-title mb-0">
            <i class="fas fa-exclamation-triangle"></i> Expiry Date Analysis
        </h5>
    </div>
    <div class="card-body">
        {% if expiring_soon_products %}
        <div class="alert alert-warning">
            <i class="fas fa-info-circle"></i>
            <strong>Warning:</strong> {{ expiring_soon_count }} products are expiring within the next 30 days.
            Total value at risk: KES {{ total_expiring_soon_value|default:0|floatformat:2 }}
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Expiry Date</th>
                        <th>Days Left</th>
                        <th>Current Stock</th>
                        <th>Stock Value</th>
                        <th>Urgency</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in expiring_soon_products %}
                    <tr class="urgency-{{ product.urgency|default:'medium' }}">
                        <td>
                            <strong>{{ product.name|truncatechars:30 }}</strong>
                            <br>
                            <small class="text-muted">{{ product.sku }}</small>
                        </td>
                        <td>{{ product.expiry_date|date:"M d, Y" }}</td>
                        <td>
                            {% with days_left=product.days_until_expiry %}
                            {% if days_left <= 7 %}
                            <span class="badge bg-danger">{{ days_left }} days</span>
                            {% elif days_left <= 14 %}
                            <span class="badge bg-warning">{{ days_left }} days</span>
                            {% else %}
                            <span class="badge bg-info">{{ days_left }} days</span>
                            {% endif %}
                            {% endwith %}
                        </td>
                        <td>{{ product.quantity }}</td>
                        <td class="text-success">KES {{ product.stock_value|floatformat:2 }}</td>
                        <td>
                            {% with days_left=product.days_until_expiry %}
                            {% if days_left <= 7 %}
                            <span class="badge bg-danger">Critical</span>
                            {% elif days_left <= 14 %}
                            <span class="badge bg-warning">High</span>
                            {% else %}
                            <span class="badge bg-info">Medium</span>
                            {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'product_detail' product.pk %}" class="btn btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-outline-warning" onclick="createExpiryPromotion({{ product.id }})">
                                    <i class="fas fa-tag"></i> Discount
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h5>No Expiring Products</h5>
            <p class="text-muted">Great! No products are expiring in the next 30 days.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Slow Moving Items -->
<div class="card mb-4 border-secondary">
    <div class="card-header bg-secondary text-white">
        <h5 class="card-title mb-0">
            <i class="fas fa-tachometer-alt"></i> Slow Moving Items
        </h5>
    </div>
    <div class="card-body">
        {% if slow_moving_products %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Note:</strong> {{ slow_moving_count }} products have low turnover rates.
            Consider promotional activities to clear this inventory.
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Category</th>
                        <th>Current Stock</th>
                        <th>Stock Value</th>
                        <th>Last Sale</th>
                        <th>Days Since Last Sale</th>
                        <th>Turnover Rate</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in slow_moving_products %}
                    <tr>
                        <td>
                            <strong>{{ product.name|truncatechars:25 }}</strong>
                            <br>
                            <small class="text-muted">{{ product.sku }}</small>
                        </td>
                        <td>{{ product.category.name|default:"Uncategorized" }}</td>
                        <td>{{ product.quantity }}</td>
                        <td class="text-success">KES {{ product.stock_value|floatformat:2 }}</td>
                        <td>
                            {% if product.last_sale_date %}
                            {{ product.last_sale_date|date:"M d, Y" }}
                            {% else %}
                            <span class="text-muted">Never</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if product.last_sale_date %}
                            {% with days_since=product.last_sale_date|timesince %}
                            {{ days_since }}
                            {% endwith %}
                            {% else %}
                            <span class="text-danger">No sales</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge 
                                {% if product.turnover_rate < 0.1 %}bg-danger
                                {% elif product.turnover_rate < 0.5 %}bg-warning
                                {% else %}bg-info{% endif %}">
                                {{ product.turnover_rate|floatformat:2 }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'product_detail' product.pk %}" class="btn btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-outline-danger" onclick="createClearanceSale({{ product.id }})">
                                    <i class="fas fa-fire"></i> Clearance
                                </button>
                                <button class="btn btn-outline-info" onclick="createBundleOffer({{ product.id }})">
                                    <i class="fas fa-gift"></i> Bundle
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h5>No Slow Moving Items</h5>
            <p class="text-muted">Great! All products have healthy turnover rates.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Fast Moving Items -->
<div class="card border-success">
    <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">
            <i class="fas fa-bolt"></i> Fast Moving Items
        </h5>
    </div>
    <div class="card-body">
        {% if fast_moving_products %}
        <div class="alert alert-success">
            <i class="fas fa-info-circle"></i>
            <strong>Top Performers:</strong> These {{ fast_moving_products|length }} products have high turnover rates.
            Consider increasing stock levels for these popular items.
        </div>
        
        <div class="row">
            {% for product in fast_moving_products %}
            <div class="col-md-3 mb-3">
                <div class="card border-success">
                    <div class="card-body">
                        <h6 class="card-title">{{ product.name|truncatechars:20 }}</h6>
                        <div class="mb-2">
                            <span class="badge bg-success">{{ product.turnover_rate|floatformat:2 }} turnover</span>
                        </div>
                        <div class="row small">
                            <div class="col-6">
                                <div class="text-muted">Stock</div>
                                <div>{{ product.quantity }}</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">Value</div>
                                <div class="text-success">KES {{ product.stock_value|floatformat:2 }}</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <a href="{% url 'product_detail' product.pk %}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-eye"></i> View
                            </a>
                            <a href="{% url 'purchase_order_create' %}?product={{ product.id }}" class="btn btn-sm btn-success">
                                <i class="fas fa-shopping-cart"></i> Reorder
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-info-circle fa-3x text-info mb-3"></i>
            <h5>No Fast Moving Items</h5>
            <p class="text-muted">No products have exceptionally high turnover rates at the moment.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Category Value Chart
    const categoryCtx = document.getElementById('categoryValueChart').getContext('2d');
    const categoryChart = new Chart(categoryCtx, {
        type: 'bar',
        data: {
            labels: [
                {% for category, data in category_analysis.items %}
                "{{ category }}"{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                label: 'Inventory Value (KES)',
                data: [
                    {% for category, data in category_analysis.items %}
                    {{ data.total_value|default:0 }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: [
                    '#ff6b6b', '#48dbfb', '#1dd1a1', '#f368e0', '#ff9f43',
                    '#6c5ce7', '#a29bfe', '#00cec9', '#fd79a8', '#ffeaa7'
                ],
                borderWidth: 1,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'KES ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    
    // ABC Analysis Chart
    const abcCtx = document.getElementById('abcAnalysisChart').getContext('2d');
    const abcChart = new Chart(abcCtx, {
        type: 'pie',
        data: {
            labels: ['A Class (High Value)', 'B Class (Medium Value)', 'C Class (Low Value)'],
            datasets: [{
                data: [
                    {{ abc_summary.A.percentage_of_value|default:0 }},
                    {{ abc_summary.B.percentage_of_value|default:0 }},
                    {{ abc_summary.C.percentage_of_value|default:0 }}
                ],
                backgroundColor: ['#28a745', '#ffc107', '#6c757d'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            return `${label}: ${value}% of total value`;
                        }
                    }
                }
            }
        }
    });
    
    // Action functions
    window.createExpiryPromotion = function(productId) {
        if (confirm('Create promotional discount for this expiring product?')) {
            // Implement promotion creation
            showToast('Promotional discount created for product', 'success');
        }
    };
    
    window.createClearanceSale = function(productId) {
        if (confirm('Create clearance sale for this slow-moving product?')) {
            // Implement clearance sale
            showToast('Clearance sale created for product', 'success');
        }
    };
    
    window.createBundleOffer = function(productId) {
        if (confirm('Create bundle offer including this product?')) {
            const bundleWith = prompt('Enter product IDs to bundle with (comma-separated):');
            if (bundleWith) {
                showToast(`Bundle offer created with products: ${bundleWith}`, 'success');
            }
        }
    };
    
    function showToast(message, type = 'info') {
        const toast = $(`
            <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `);
        
        const container = $('#toastContainer');
        if (!container.length) {
            $('body').append('<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>');
        }
        $('#toastContainer').append(toast);
        
        const bsToast = new bootstrap.Toast(toast[0]);
        bsToast.show();
        
        toast.on('hidden.bs.toast', function () {
            $(this).remove();
        });
    }
});
</script>
{% endblock %}